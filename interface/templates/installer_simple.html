<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Agent IA Nocturne - Installateur</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
        }
        .progress {
            height: 10px;
            border-radius: 5px;
        }
        .log-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        .step {
            text-align: center;
            flex: 1;
        }
        .step-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            transition: all 0.3s;
        }
        .step.active .step-icon {
            background: #667eea;
            color: white;
        }
        .step.completed .step-icon {
            background: #28a745;
            color: white;
        }
        .security-note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-body p-5">
                        <div class="text-center mb-4">
                            <h1 class="display-4 mb-3">ü§ñ Agent IA Nocturne</h1>
                            <p class="lead text-muted">Installateur Automatique</p>
                        </div>

                        <!-- Note de s√©curit√© -->
                        <div class="security-note">
                            <i class="fas fa-shield-alt text-warning"></i>
                            <strong>S√©curit√© :</strong> Vos cl√©s API et mots de passe sont transmis de mani√®re s√©curis√©e et ne sont jamais affich√©s dans les logs.
                        </div>

                        <!-- √âtapes d'installation -->
                        <div class="step-indicator">
                            <div class="step" id="step-python">
                                <div class="step-icon">
                                    <i class="fas fa-code"></i>
                                </div>
                                <small>Python</small>
                            </div>
                            <div class="step" id="step-venv">
                                <div class="step-icon">
                                    <i class="fas fa-folder"></i>
                                </div>
                                <small>Environnement</small>
                            </div>
                            <div class="step" id="step-deps">
                                <div class="step-icon">
                                    <i class="fas fa-download"></i>
                                </div>
                                <small>D√©pendances</small>
                            </div>
                            <div class="step" id="step-config">
                                <div class="step-icon">
                                    <i class="fas fa-cog"></i>
                                </div>
                                <small>Configuration</small>
                            </div>
                            <div class="step" id="step-launch">
                                <div class="step-icon">
                                    <i class="fas fa-rocket"></i>
                                </div>
                                <small>Lancement</small>
                            </div>
                        </div>

                        <!-- V√©rification syst√®me -->
                        <div id="system-check" class="mb-4">
                            <h5><i class="fas fa-check-circle text-success"></i> V√©rification du syst√®me</h5>
                            <div id="system-info"></div>
                        </div>

                        <!-- Formulaire de configuration -->
                        <div id="config-form" class="mb-4">
                            <h5><i class="fas fa-cog"></i> Configuration</h5>
                            <form id="install-form">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Cl√© API OpenAI</label>
                                        <input type="password" class="form-control" name="openai_key" placeholder="sk-..." required>
                                        <small class="text-muted">Votre cl√© API OpenAI (commence par sk-)</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Cl√© API Mistral</label>
                                        <input type="password" class="form-control" name="mistral_key" placeholder="..." required>
                                        <small class="text-muted">Votre cl√© API Mistral</small>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Email Gmail</label>
                                        <input type="email" class="form-control" name="email" placeholder="votre@gmail.com" required>
                                        <small class="text-muted">Email Gmail pour la surveillance</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Mot de passe App</label>
                                        <input type="password" class="form-control" name="password" placeholder="Mot de passe d'application" required>
                                        <small class="text-muted">Mot de passe d'application Gmail (pas votre mot de passe principal)</small>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Budget minimum (‚Ç¨)</label>
                                        <input type="number" class="form-control" name="budget_min" value="500">
                                        <small class="text-muted">Budget minimum des missions</small>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Dur√©e max (jours)</label>
                                        <input type="number" class="form-control" name="duration_max" value="30">
                                        <small class="text-muted">Dur√©e maximale des missions</small>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Seuil de pertinence</label>
                                        <input type="number" class="form-control" name="relevance" value="7" min="1" max="10">
                                        <small class="text-muted">Seuil de pertinence (1-10)</small>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Signature</label>
                                    <input type="text" class="form-control" name="signature" value="Agent IA Nocturne - D√©veloppeur Backend Python/IA">
                                    <small class="text-muted">Signature pour les r√©ponses automatiques</small>
                                </div>
                                <button type="submit" class="btn btn-primary btn-lg w-100" id="install-btn">
                                    <i class="fas fa-rocket"></i> Lancer l'Installation
                                </button>
                            </form>
                        </div>

                        <!-- Barre de progression -->
                        <div id="progress-section" class="mb-4" style="display: none;">
                            <h5><i class="fas fa-spinner fa-spin"></i> Installation en cours...</h5>
                            <div class="progress mb-3">
                                <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <p id="progress-message" class="text-muted">Pr√©paration...</p>
                        </div>

                        <!-- Logs -->
                        <div id="logs-section" class="mb-4" style="display: none;">
                            <h5><i class="fas fa-terminal"></i> Logs d'installation</h5>
                            <div class="log-container" id="log-container"></div>
                        </div>

                        <!-- Bouton de lancement -->
                        <div id="launch-section" class="text-center" style="display: none;">
                            <h5 class="text-success"><i class="fas fa-check-circle"></i> Installation termin√©e !</h5>
                            <p class="text-muted">Votre agent est pr√™t √† √™tre utilis√©</p>
                            <button class="btn btn-success btn-lg" onclick="launchApp()">
                                <i class="fas fa-external-link-alt"></i> Ouvrir l'Interface
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // V√©rification syst√®me au chargement
        document.addEventListener('DOMContentLoaded', function() {
            checkSystem();
        });

        function checkSystem() {
            fetch('/api/check-system')
                .then(response => response.json())
                .then(data => {
                    const systemInfo = document.getElementById('system-info');
                    systemInfo.innerHTML = `
                        <div class="alert alert-info">
                            <strong>Syst√®me:</strong> ${data.os}<br>
                            <strong>Python:</strong> ${data.python_msg}<br>
                            <strong>Version:</strong> ${data.python_version}
                        </div>
                    `;
                })
                .catch(error => {
                    console.error('Erreur v√©rification syst√®me:', error);
                });
        }

        // Gestion du formulaire
        document.getElementById('install-form').addEventListener('submit', function(e) {
            e.preventDefault();
            startInstallation();
        });

        function startInstallation() {
            const form = document.getElementById('install-form');
            const formData = new FormData(form);
            const config = {};
            
            for (let [key, value] of formData.entries()) {
                config[key] = value;
            }

            // Afficher la progression
            document.getElementById('progress-section').style.display = 'block';
            document.getElementById('logs-section').style.display = 'block';
            document.getElementById('install-btn').disabled = true;

            // Lancer l'installation
            fetch('/api/install', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ config: config })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'started') {
                    pollStatus();
                }
            })
            .catch(error => {
                console.error('Erreur lancement installation:', error);
                updateProgress(0, 'Erreur lors du lancement');
            });
        }

        function pollStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    updateProgress(data.progress, data.message);
                    updateSteps(data.step);
                    updateLogs(data.logs);

                    if (data.error) {
                        updateProgress(0, 'Erreur: ' + data.error);
                        document.getElementById('install-btn').disabled = false;
                    } else if (data.step === 'complete') {
                        setTimeout(() => {
                            document.getElementById('launch-section').style.display = 'block';
                        }, 2000);
                    } else {
                        setTimeout(pollStatus, 1000);
                    }
                })
                .catch(error => {
                    console.error('Erreur polling status:', error);
                    setTimeout(pollStatus, 2000);
                });
        }

        function updateProgress(progress, message) {
            document.getElementById('progress-bar').style.width = progress + '%';
            document.getElementById('progress-bar').textContent = progress + '%';
            document.getElementById('progress-message').textContent = message;
        }

        function updateSteps(currentStep) {
            const steps = ['python', 'venv', 'deps', 'config', 'launch'];
            steps.forEach(step => {
                const stepElement = document.getElementById('step-' + step);
                stepElement.classList.remove('active', 'completed');
                
                if (step === currentStep) {
                    stepElement.classList.add('active');
                } else if (steps.indexOf(step) < steps.indexOf(currentStep)) {
                    stepElement.classList.add('completed');
                }
            });
        }

        function updateLogs(logs) {
            const logContainer = document.getElementById('log-container');
            // Masquer les informations sensibles dans les logs
            const sanitizedLogs = logs.map(log => {
                return log.replace(/sk-[a-zA-Z0-9]+/g, 'sk-***')
                         .replace(/password.*?=.*?['"][^'"]*['"]/gi, 'password=***')
                         .replace(/token.*?=.*?['"][^'"]*['"]/gi, 'token=***');
            });
            logContainer.innerHTML = sanitizedLogs.map(log => `<div>${log}</div>`).join('');
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function launchApp() {
            fetch('/api/launch-app')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        window.open('http://localhost:8080', '_blank');
                    }
                })
                .catch(error => {
                    console.error('Erreur lancement app:', error);
                    window.open('http://localhost:8080', '_blank');
                });
        }
    </script>
</body>
</html> 